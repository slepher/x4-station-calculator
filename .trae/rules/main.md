# 核心上下文感知与工作流原则 (Core Context & Workflow Protocol)

## 1. 上下文锚定与状态检测 (Context Anchoring & State Detection)

### 1.1 目标文件锚定
- **显式指定**：若用户指令中包含文件名，则在当前目录进行模糊搜索。
- **隐式推断**：若用户未指定文件名，且当前编辑器有打开的文件，则默认以当前打开文件为目标上下文 (`${filename}`)。
- **歧义处理**：若模糊搜索匹配到多个文件，必须**立即暂停**，列出候选项并要求用户明确指定，不得盲目执行。

### 1.2 模式仲裁 (Mode Arbitration)
确认目标 (`${filename}`) 后，系统需优先检查同级目录下是否存在对应的缺陷记录文件 `${filename}_bug.md`。
1.  **Bug 模式 (High Priority)**：
    - 若 `${filename}_bug.md` 存在且包含**未勾选**的任务项 (`- [ ]`)。
    - **动作**：强制进入 [Bug 修复模式]，暂缓任何新功能开发。
2.  **开发模式 (Standard)**：
    - 若 `${filename}_bug.md` 不存在，或其中所有条目均已标记为已修复 (`- [x]`)。
    - **动作**：自动进入 [开发执行模式]。

## 2. 工作流执行规范 (Execution Workflow)

基于 VSCode 交互限制优化，确保心流连贯性与文档完整性。

### 2.1 Bug 修复模式 (Bug Fix Mode)
**触发条件**：检测到活跃的 Bug 文档。
1.  **专注修复**：仅读取 `${filename}_bug.md` 和相关代码，逐一修复缺陷。
2.  **即时状态更新**：每修复一个问题，立即将文档中的对应项标记为已完成 (`- [x]`)。
3.  **模式切换**：当所有缺陷项修复完毕后，自动转入 [开发执行模式]。

### 2.2 开发执行模式 (Development Mode)
**触发条件**：无遗留 Bug，进入正常开发流程。

**Phase A: 任务定位 (Task Localization)**
- 读取 `${filename}_checklist.md`，定位**首个未完成**的任务项 (`- [ ]`)。
- 读取主规格书 `${filename}.md` 中与该任务相关的功能点和约束条件。

**Phase B: 代码执行 (Implementation)**
- **心流保护**：在此阶段专注代码实现或重构，**不进行**文档更新操作，避免频繁打断。
- 基于 Phase A 获取的需求执行开发。

**Phase C: 事后文档同步 (Post-Implementation Sync)**
- **触发时机**：代码任务执行完成后。
- **批量处理**：
    1.  **更新进度**：将 `${filename}_checklist.md` 中对应的任务项标记为已完成 (`- [x]`)。
    2.  **同步规格**：若代码实现导致功能点或约束发生变更，更新 `${filename}.md`。
    3.  **记录新缺陷**：若开发过程中发现新问题，写入 `${filename}_bug.md`（如有必要）。
- **完整性验证**：确认代码实现与所有文档状态（Spec/Checklist/Bug）保持一致。

## 3. 关键原则摘要 (Key Principles)

- **Bug 优先 (Bug First)**：未解决的 Bug 必须在开发新功能前被清除。
- **心流保护 (Flow Protection)**：文档维护操作应在“开发前读取”或“开发后同步”时集中处理，严禁在编码过程中频繁要求用户确认文档变更。
- **单一事实来源 (Single Source of Truth)**：代码实现必须最终映射回 `${filename}.md` 和 `${filename}_checklist.md`，确保文档即时反映项目现状。


** 复读原则 **
  - 每次读到这个协议的时候, 必须以自己的理解复述该协议, 并和我确认自己的理解是否正确