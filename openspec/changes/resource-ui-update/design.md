# 设计文档：产线性能分析重构 (Production Line Performance Analysis Refactor)

## Context

当前产线性能分析界面虽然采用三栏布局，但存在功能分散问题：右侧面板的 `StationProfit` 组件与中间栏的 `ResourceList` 组件功能重叠且分离，用户需要在不同组件间切换来查看完整的产线性能分析。通过组件合并和统一分析视图，可以显著提升用户界面的内聚性和信息密度。

## Goals / Non-Goals

**Goals:**
- 将 `StationProfit` 组件功能合并到 `ResourceList` 组件中
- 重命名合并后的组件为 `StationResourceDashboard`
- 实现统一的资源仪表盘，支持数量、体积、经济三种视图模式
- 优化用户体验，减少认知负荷和组件切换
- 新增体积分析功能，完善产线性能分析维度
- 参照calculateProfitBreakdown方法, 新建为analyzeWareFlow函数, 使其输出的结果中同时包含数量、体积、经济分析数据

**Non-Goals:**
- 不修改现有的三栏布局结构
- 不改变左栏模块规划和右栏后勤状态功能

## Decisions

### 决策：组件功能合并
将右侧 `StationProfit` 组件的经济分析功能合并到中间栏的 `ResourceList` 组件中，创建统一的 `StationResourceDashboard` 组件。

**理由**：经济分析本质上与资源产出分析共享同一套数据源，将它们聚合在同一组件中可以减少用户在不同组件间切换的认知负荷，提高信息密度。

### 决策：统一分析视图 (Unified Analysis Lens)
实现一个统一的 `StationResourceDashboard` 组件，包含三个互斥的视图：
1. **数量流视图 (Quantity Flow)**：展示传统的单位产出 (`/h`)，关注生产平衡
2. **体积流视图 (Volume Flow)**：新增维度，计算 `数量 * 单体体积`，关注空间压缩效率
3. **资金流视图 (Economy Flow)**：集成原有的经济分析，应用价格设置，关注利润与产值

**理由**：这三个维度本质上共享同一套数据源（产物列表），只是观察透镜不同（物品 vs 体积 vs 价值）。将它们聚合在同一物理区域可以极大提高屏幕空间利用率。

### 决策：体积计算逻辑分离 (Volume Calculation Logic)
严格区分"体积流 (Flow)"与"存储容量 (Stock)"的计算逻辑：
- **性能视图 (中栏)**：计算 `吞吐量 (m³/h)` 和 `净变化量`。它代表产线的物理效率
- **后勤视图 (右栏)**：基于缓冲时间计算 `静态存储需求`

**理由**：清晰区分"流量"与"存量"。中间栏只关注每小时吞吐的变化，不负责计算需要多少个仓库，避免逻辑耦合。

## Risks / Trade-offs

**风险**：
- 组件合并可能影响现有用户的使用习惯
- 统一视图组件需要处理复杂的状态管理

**缓解措施**：
- 保持视图切换的直观性，减少学习成本
- 实现平滑的视图切换动画，提升用户体验
- 充分测试确保数据计算的准确性

## 实施后补充 (Post-Implementation Notes)

### 经济视图重构
- 经济视图的数据源不再使用profitBreakdown，而是使用wareFlowList
- 经济视图将产物分为三组：产品收入、运营支出、资源支出
- 支出分类取决于transportType：非container类型的负值为资源支出，container类型的负值为运营支出
- 分组从上到下依次为：产品收入组、运营支出组、资源支出组
- 每组标题栏显示该组内netValue的总和，正数绿色，负数红色
- 移除了经济视图下方的总产值和运营支出显示，保留profitTotal显示

### 资源视图重构
- 资源视图的数据源也使用wareFlowList，与经济视图保持一致
- 资源视图采用相同的三组分组方式：产品组、运营组、资源组
- 资源视图的分组标题为：产品、运营、资源，不显示汇总（因不同产品产量不能相加）
- 所有视图的分组内部排序都遵循plannedModules中对应模块的顺序

### 代码优化
- 实现了通用的groupByTypeAndSign函数，减少代码重复
- 统一了三个视图（数量、体积、经济）的排序逻辑
- 体积视图现在也使用与数量和经济视图相同的排序策略